<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AdminAX | Mobile Scanner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #333; color: white; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .camera-btn { width: 150px; height: 150px; border-radius: 50%; border: 8px solid #fff; background: #0d6efd; color: white; font-weight: bold; font-size: 1.2rem; transition: 0.2s; }
        .camera-btn:active { transform: scale(0.9); background: #0056b3; }
        .camera-btn:disabled { background: #666; border-color: #999; }
        #statusInfo { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); width: 85%; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #statusInfo.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>
    <div id="statusInfo" class="alert shadow-lg py-2 small text-center">ğŸ“¡ ì„œë²„ ì—°ê²° ì¤‘...</div>
    <div class="text-center px-4">
        <h4 class="mb-5 fw-bold">ğŸ“· ì˜ìˆ˜ì¦ ì´¬ì˜</h4>
        <button id="shotBtn" class="camera-btn shadow-lg" disabled onclick="document.getElementById('cam').click()">ì´¬ì˜</button>
        <input type="file" id="cam" accept="image/*" capture="environment" style="display:none" onchange="processAndSend(this)">
        <p class="mt-4 text-secondary small">ì´¬ì˜ ì¦‰ì‹œ ìµœì í™” ì••ì¶• í›„ PCë¡œ ì „ì†¡ë©ë‹ˆë‹¤.</p>
    </div>

    <script>
        const statusInfo = document.getElementById('statusInfo');
        const sid = new URLSearchParams(window.location.search).get('sid');
        let toastTimer;

        function notify(msg, type, duration = 3000) {
            if (toastTimer) clearTimeout(toastTimer);
            statusInfo.innerText = msg;
            statusInfo.className = `alert alert-${type} shadow-lg py-2 small text-center show`;
            if (duration > 0) toastTimer = setTimeout(() => statusInfo.classList.remove('show'), duration);
        }
        
        // [Anchor Strategy] ì„œë¹„ìŠ¤ ê²½ë¡œ(/receipt)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ ë£¨íŠ¸ë¥¼ ë™ì ìœ¼ë¡œ ì¶”ì¶œ
        // URLì´ /api/receipt/mobile ì´ë©´ contextRootëŠ” /api ê°€ ë©ë‹ˆë‹¤.
        const contextRoot = window.location.pathname.split('/receipt')[0];

        // WebSocket ì£¼ì†Œ ì¡°ë¦½ (ë¸Œë¼ìš°ì €ê°€ í”„ë¡œí† ì½œ/í˜¸ìŠ¤íŠ¸/í¬íŠ¸ë¥¼ ì•Œì•„ì„œ ì™„ì„±)
        const socketUrl = new URL(contextRoot + '/ws/receipt' + window.location.search, window.location.href).href.replace(/^http/, 'ws');

        const ws = new WebSocket(socketUrl);
        ws.onopen = () => { 
            notify("âœ… PCì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", "success", 2000); 
            document.getElementById('shotBtn').disabled = false; 
        };
        ws.onclose = () => { 
            notify("âŒ ì—°ê²° ëŠê¹€ (ì„œë²„ í™•ì¸ í•„ìš”)", "danger", 0); 
            document.getElementById('shotBtn').disabled = true; 
        };

        async function processAndSend(input) {
            const file = input.files[0];
            if (!file) return;
            notify("â³ ì´ë¯¸ì§€ ìµœì í™” ì¤‘...", "warning", 0);
            try {
                const compressedDataUrl = await compressImage(file);
                ws.send(JSON.stringify({ 
                    sid: sid, 
                    type: "MOBILE_UPLOAD", 
                    fileName: "MOB_" + Date.now() + ".jpg", 
                    data: compressedDataUrl 
                }));
                notify("âœ… ì „ì†¡ ì™„ë£Œ!", "success", 2000);
            } catch (err) { 
                notify("âŒ ì••ì¶•/ì „ì†¡ ì‹¤íŒ¨", "danger", 3000); 
            }
            input.value = "";
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        const MAX_WIDTH = 1600;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }
    </script>
</body>
</html>